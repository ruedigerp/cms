<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Page - CMS ðŸ¤©ðŸ§¦ðŸ¤¨ example</title>
  <link href="https://fonts.googleapis.com/css?family=PT+Mono" rel="stylesheet">
  <link href="/static/assets/demo.css" rel="stylesheet">
  <script src="/static/assets/json-preview.js"></script>
  <script   src="https://code.jquery.com/jquery-3.5.1.min.js"   integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="   crossorigin="anonymous"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <style>
form {
width: 40em;
}

label.h2 {
font-weight: bold;
font-size: 150%;
width: 100%;
margin-bottom: 1em;
}

input, label {
float: left;
width: 40%;
}
input {
margin: 0 0 1em .2em;
padding: .2em .5em;
background-color: #fffbf0;
border: 1px solid #e7c157;
}
label.input {
text-align: right;
line-height: 1.5;
}
label.input::after {
content: ": ";
}
button {
margin-top: 1.5em;
width: 30%;
}
.up-button, .down-button, .delete-button {
  width: 50px;
}
</style>
</head>
<body>
  <div class="ce-example">
    <div class="ce-example__header">
      <div id="saved" style="color: #f00; visibilty: hidden ">Gespeichert</div>
      <div class="ce-example__header-menu">
        <a href="/admin/index.html" >Artikelliste</a>
        <form id="metaformnew" action="/api/v1/articles" METHOD="POST">
          <script>
          document.write('<input type="hidden" name="callback" id="callback" value="' +  location.host + '" maxlength="50">');
          </script>
          <button type="submit">New Article</button>
        </form>
      </div>
    </div>
    <div class="ce-example__content _ce-example__content--small">
    </div>
    <div class="ce-example__content _ce-example__content--small">
      <div id="metaformd">
      <form id="metaform" action="/api/v1/metadata" METHOD="PUT">
          <label class="h2" form="person">Seite Ã¤ndern</label>
          <div id="metaformdata"></div>
          <div id="childlist"></div>
          <div id="addChildButton"></div>
          <button type="reset">Eingaben zurÃ¼cksetzen</button>
          <button type="button" onclick="sendForm();">Eingaben absenden</button>
      </form>
      </div>
    </div>
    <script>
      $("#saved").delay(1).fadeOut(1);
      function sendForm(){
        var frm = $("#metaform");
        var data = JSON.stringify(frm.serializeArray());
        console.log("Data from form: " + data);
        let url = '/api/v1/pages';
        $.ajax({
            url: url,
            type: 'PUT',
            contentType: 'application/json; charset=utf-8',
            data: data,
            success: function (response) {
                $("#saved").delay(20).fadeIn(500);
                $("#saved").delay(2000).fadeOut(500);
            },
            error: function (xhr) {
                alert('Error: There was some error while posting. Please try again later.');
            }
        });
      }
      const capitalize = (s) => {
        if (typeof s !== 'string') return ''
        return s.charAt(0).toUpperCase() + s.slice(1)
      }
      function addChild(childcounter) {
        newRowContent = '<div class="leg">';
        newRowContent += '<div style="float: left; width: 100px;">Child: </div>';
        newRowContent += '<div style="float: left; width: 600px;"><input type="text" name="childs" id="'+k+'" value="" mxlength="50">';
        newRowContent += '<input type="button" value="Up" class="up-button"/>';
        newRowContent += '<input type="button" value="Down" class="down-button"/>';
        newRowContent += '<input type="button" value="Delete" class="delete-button"/>';
        newRowContent += '</div>';
        newRowContent += '<div style="clear: both;"></div></div>';
        $("#childlist").append(newRowContent);
        childcounter++;
        $('.up-button').click(function(){
          $(this).parents('.leg').insertBefore($(this).parents('.leg').prev());
        });
        $('.down-button').click(function(){
          $(this).parents('.leg').insertAfter($(this).parents('.leg').next());
        });
        $('.delete-button').click(function(){
          $(this).parents('.leg').remove();
        });
        return childcounter;
      }
      function dataTable(data) {
        var newRowContent = "";
        var childcounter = 0;
        for ( [k,v] of Object.entries(data)) {
          if ( k.includes("childs") ) {
            console.log("Is Child field.");
            for ( child in v ) {
              console.log("Child: " + child + " " + v[child]);
              newRowContent = '<div class="leg">';
              newRowContent += '<div style="float: left; width: 100px;">'+capitalize(k)+childcounter+': </div>';
              newRowContent += '<div style="float: left; width: 600px;"><input type="text" name="'+k+'" id="'+k+'" value="'+v[child]+'" mxlength="50">';
              newRowContent += '<input type="button" value="Up" class="up-button"/>';
              newRowContent += '<input type="button" value="Down" class="down-button"/>';
              newRowContent += '<input type="button" value="Delete" class="delete-button"/>';
              newRowContent += '</div></div>';
              newRowContent += '<div style="clear: both;"></div>';
              $("#childlist").append(newRowContent);
              childcounter++;
            }
            newRowContent = '<div id="addchild" style="float: left; width: 100px;">Child: </div>';
            newRowContent += '<div style="float: left; width: 600px;"><input type="button" onclick="childcounter = addChild('+childcounter+');" name="addchild" id="addchild" value="hinzufÃ¼gen" maxlength="50"></div>';
            newRowContent += '<div style="clear: both;"></div>';
            $("#addChildButton").append(newRowContent);
          } else {
            newRowContent = '<div style="float: left; width: 100px;">'+capitalize(k)+': </div>';
            newRowContent += '<div style="float: left; width: 600px;"><input type="text" name="'+k+'" id="'+k+'" value="'+v+'" mxlength="50"></div>';
            newRowContent += '<div style="clear: both;"></div>';
            $("#metaformdata").append(newRowContent);
          }
        }
        $('.up-button').click(function(){
          $(this).parents('.leg').insertBefore($(this).parents('.leg').prev());
        });
        $('.down-button').click(function(){
          $(this).parents('.leg').insertAfter($(this).parents('.leg').next());
        });
        $('.delete-button').click(function(){
          $(this).parents('.leg').remove();
        });
      }
      async function fetchData() {
        let parts = window.location.pathname.split( '/' );
        let url = '/api/v1/pages/' + parts[3];
        return fetch(url)
          .then(data => {return data.json() })
          .then(res => { dataTable(res) })
      }
      fetchData()
    </script>


    <div class="ce-example__output">
    </div>
  </div>
</body>
</html>
